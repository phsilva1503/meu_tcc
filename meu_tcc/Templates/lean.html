<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Dashboard Lean Six Sigma</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <h1>Dashboard Lean Six Sigma</h1>
    <p>Tempo médio: <span id="tempoMedio">{{ tempo_medio }}</span> dias</p>
    <p>Taxa de retrabalho: <span id="taxaRetrabalho">{{ taxa_retrabalho }}</span>%</p>

    <h2>Pareto de Falhas</h2>
    <canvas id="paretoChart"></canvas>

    <h2>Tendência de Atendimentos</h2>
    <canvas id="tendenciaChart"></canvas>

    <script>
        let paretoChart, tendenciaChart;

        async function atualizarDados() {
            const res = await fetch('/lean-data');
            const dados = await res.json();

            // Atualiza métricas
            let tempoMedio = dados.reduce((acc, item) => acc + Number(item["Tempo de Atendimento"]), 0) / dados.length;
            let taxaRetrabalho = (dados.filter(item => item["Retrabalho"] == 1).length / dados.length) * 100;

            document.getElementById('tempoMedio').textContent = tempoMedio.toFixed(2);
            document.getElementById('taxaRetrabalho').textContent = taxaRetrabalho.toFixed(2);

            // Dados Pareto
            const falhas = {};
            dados.forEach(item => {
                falhas[item.Problema] = (falhas[item.Problema] || 0) + 1;
            });

            const labelsPareto = Object.keys(falhas);
            const valoresPareto = Object.values(falhas);

            if (paretoChart) {
                paretoChart.data.labels = labelsPareto;
                paretoChart.data.datasets[0].data = valoresPareto;
                paretoChart.update();
            } else {
                paretoChart = new Chart(document.getElementById('paretoChart'), {
                    type: 'bar',
                    data: {
                        labels: labelsPareto,
                        datasets: [{
                            label: 'Ocorrências',
                            data: valoresPareto,
                            backgroundColor: 'rgba(54, 162, 235, 0.7)'
                        }]
                    }
                });
            }

            // Tendência (exemplo usando Data de Atendimento)
            const datas = {};
            dados.forEach(item => {
                datas[item.Data] = (datas[item.Data] || 0) + 1;
            });

            const labelsTendencia = Object.keys(datas).sort();
            const valoresTendencia = labelsTendencia.map(d => datas[d]);

            if (tendenciaChart) {
                tendenciaChart.data.labels = labelsTendencia;
                tendenciaChart.data.datasets[0].data = valoresTendencia;
                tendenciaChart.update();
            } else {
                tendenciaChart = new Chart(document.getElementById('tendenciaChart'), {
                    type: 'line',
                    data: {
                        labels: labelsTendencia,
                        datasets: [{
                            label: 'Atendimentos',
                            data: valoresTendencia,
                            borderColor: 'rgba(255, 99, 132, 1)',
                            fill: false
                        }]
                    }
                });
            }
        }

        atualizarDados();
        setInterval(atualizarDados, 10000);
    </script>
</body>
</html>
